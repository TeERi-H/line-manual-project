# LINE業務マニュアルBot システム 要件定義書

**バージョン:** 1.0  
**作成日:** 2025年8月27日  
**プロジェクト名:** LINE Manual Project

---

## 1. プロジェクト概要

### 1.1 システムの目的
社内業務マニュアルをLINE Bot経由で検索・閲覧できるシステムを構築し、従業員の業務効率化と問い合わせ対応の自動化を実現する。

### 1.2 想定ユーザー
- **一般従業員**: 業務マニュアルの検索・閲覧
- **総務・管理者**: ユーザー管理、統計確認、問い合わせ対応
- **役職者**: 全機能へのアクセス

### 1.3 システム概要
LINEプラットフォーム上で動作する対話型Botシステム。Google Sheetsをデータベースとして使用し、Vercel Serverless Functionsで動作する。

---

## 2. 機能要件

### 2.1 ユーザー管理機能

#### 2.1.1 ユーザー登録
- **登録フロー**: 3段階（メールアドレス → 氏名 → 確認 → 完了）
- **入力検証**:
  - メールアドレス: 形式検証、ドメイン制限（環境変数で設定可能）、重複チェック
  - 氏名: 1-50文字、日本語・英数字対応
- **自動取得**: LINE プロフィール情報（表示名、画像）
- **初期権限**: デフォルトで「一般」権限を付与

#### 2.1.2 権限管理
- **権限レベル**:
  1. **一般(1)**: 基本的なマニュアル閲覧
  2. **総務(2)**: 一般機能 + 管理機能
  3. **役職(3)**: 全機能へのアクセス
- **アクセス制御**: マニュアルの閲覧権限、管理機能のアクセス制御

#### 2.1.3 ユーザー状態管理
- **セッション管理**: メモリ内での状態管理（登録フロー、問い合わせフロー）
- **タイムアウト**: 各フローで5-10分のタイムアウト設定
- **状態種別**: INITIAL、REGISTERING_EMAIL、REGISTERING_NAME、CONFIRMING_REGISTRATION、INQUIRY_TYPE、INQUIRY_CONTENT、CONFIRMING_INQUIRY

### 2.2 マニュアル管理・検索機能

#### 2.2.1 マニュアル検索
- **検索方式**:
  - **キーワード検索**: タイトル・内容・タグでの部分一致
  - **カテゴリ検索**: 6つの主要カテゴリ（経理、人事、IT、総務、営業、製造）
- **スコアリングシステム**:
  - タイトル完全一致: 1.0
  - タイトル部分一致: 0.8
  - タグ一致: 0.6
  - 内容部分一致: 0.5
  - カテゴリ一致: 0.4
- **制限事項**:
  - 最大表示件数: 10件
  - 最小キーワード長: 2文字
  - 最小関連度スコア: 0.3

#### 2.2.2 マニュアル詳細表示
- **表示内容**: タイトル、本文（1000文字制限）、画像、動画、外部リンク
- **関連マニュアル**: 自動提案（最大3件）
  - 関連度算出: カテゴリ(0.6) + タグ(0.2×件数) + タイトル類似度(0.1×件数)
- **アクセス制御**: ユーザー権限に応じた表示制限

#### 2.2.3 カテゴリ分類
- **大カテゴリ**: 経理、人事、IT、総務、営業、製造
- **中カテゴリ**: 各大カテゴリ内での詳細分類
- **小カテゴリ**: さらに詳細な分類
- **タグシステム**: 横断的なキーワードタグ

### 2.3 問い合わせ機能

#### 2.3.1 問い合わせフロー
- **4段階フロー**: 種別選択 → 内容入力 → 確認 → 送信完了
- **問い合わせ種別**:
  1. 質問・疑問
  2. 要望・改善提案
  3. 不具合報告
  4. その他
- **入力制限**: 10-1000文字
- **タイムアウト**: 10分間

#### 2.3.2 問い合わせ管理
- **受付番号**: INQ + タイムスタンプ形式での自動発行
- **ステータス管理**: 未対応(pending)、対応中、完了、保留
- **管理者機能**: 問い合わせ一覧表示（最新10件）

### 2.4 管理者機能

#### 2.4.1 管理者コマンドシステム
- **基本コマンド**: 
  - `admin` - システム統計表示
  - `admin users` - ユーザー一覧表示
  - `admin inquiries` - 未対応問い合わせ一覧
  - `admin system` - システム状態確認
  - `admin logs` - アクセスログ表示
- **権限制御**: 総務・役職権限のみアクセス可能

#### 2.4.2 システム統計
- **基本統計**: 登録ユーザー数、マニュアル数、今日の問い合わせ数、システム稼働時間
- **詳細統計**:
  - ユーザー統計: 権限別ユーザー数、今月の新規登録者数
  - マニュアル統計: カテゴリ別件数
  - 検索統計: 人気検索キーワード、アクセス数
  - 問い合わせ統計: 種別件数、対応状況

#### 2.4.3 ユーザー管理
- **ユーザー一覧**: 権限別での表示
- **基本情報**: 氏名、メールアドレス、権限、登録日、最終アクセス

#### 2.4.4 システム監視
- **アクセスログ**: 最新20件の表示
- **システム状態**: データベース接続、LINE API接続、パフォーマンス情報
- **エラー監視**: 各機能の動作状況

#### 2.4.5 問い合わせ管理
- **管理者通知**: Flex Messageでの即座通知
- **対応状況管理**: 未対応、対応中、完了、保留の4状態管理
- **対応履歴**: 対応者・対応内容の記録

### 2.5 リッチメニュー機能

#### 2.5.1 一般ユーザー用メニュー
- **サイズ**: 2500x1686ピクセル
- **エリア構成**: 6つのタップエリア
  1. 検索機能
  2. カテゴリ選択
  3. 問い合わせ
  4. ヘルプ
  5. 使い方
  6. メニュー表示

#### 2.5.2 管理者用メニュー
- **サイズ**: 2500x2108ピクセル
- **エリア構成**: 8つのタップエリア
  - 基本機能（6つ） + 管理機能（2つ）
  7. 管理統計
  8. システム管理

#### 2.5.3 自動切り替え・動的更新
- **権限判定**: ユーザー権限に応じた自動メニュー表示
- **動的更新**: 権限変更時の自動メニュー切り替え
- **実装仕様**: 
  - 初回友だち追加時の権限判定とメニュー設定
  - 権限変更時の即座メニュー更新
  - メニューID管理（一般用・管理者用の2種類）

---

## 3. 非機能要件

### 3.1 パフォーマンス要件
- **レスポンス時間**: 通常操作で3秒以内
- **検索処理**: 10秒以内
- **同時アクセス**: 100ユーザーまで対応

### 3.2 可用性要件
- **稼働率**: 99%以上
- **メンテナンス時間**: 月次で最大2時間

### 3.3 セキュリティ要件
- **認証**: LINE OAuth認証
- **データ暗号化**: Google Service Account認証
- **アクセス制御**: 権限ベースのデータアクセス制限
- **監査ログ**: 全アクセス履歴の記録

### 3.4 運用要件
- **バックアップ**: Google Sheetsでの自動バージョン管理
- **ログ保存**: アクセスログの永続化
- **監視**: エラー通知、パフォーマンス監視

---

## 4. 技術仕様

### 4.1 システム構成
- **プラットフォーム**: Vercel (Serverless Functions)
- **ランタイム**: Node.js (JavaScript)
- **データベース**: Google Sheets (googleapis)
- **外部API**: LINE Messaging API (@line/bot-sdk)

### 4.2 データ構造

#### 4.2.1 ユーザーデータ (users)
| フィールド名 | データ型 | 必須 | 説明 |
|-------------|----------|------|------|
| email | string | ○ | メールアドレス（主キー） |
| name | string | ○ | 氏名 |
| permission | number | ○ | 権限レベル（1-3） |
| line_id | string | ○ | LINE ユーザーID |
| created_at | datetime | ○ | 登録日時 |
| last_access | datetime | ○ | 最終アクセス日時 |
| is_active | boolean | ○ | 有効フラグ |

#### 4.2.2 マニュアルデータ (manuals)
| フィールド名 | データ型 | 必須 | 説明 |
|-------------|----------|------|------|
| id | string | ○ | マニュアルID（主キー） |
| category_main | string | ○ | 大カテゴリ |
| category_sub | string | - | 中カテゴリ |
| category_detail | string | - | 小カテゴリ |
| title | string | ○ | タイトル |
| content | text | ○ | 本文 |
| image_url | string | - | 画像URL |
| video_url | string | - | 動画URL |
| view_permission | number | ○ | 閲覧権限レベル |
| tags | string | - | タグ（カンマ区切り） |
| updated_at | datetime | ○ | 更新日時 |
| is_active | boolean | ○ | 有効フラグ |

#### 4.2.3 アクセスログ (access_logs)
| フィールド名 | データ型 | 必須 | 説明 |
|-------------|----------|------|------|
| timestamp | datetime | ○ | アクセス日時 |
| line_id | string | ○ | LINE ユーザーID |
| user_name | string | ○ | ユーザー名 |
| action | string | ○ | アクション種別 |
| search_keyword | string | - | 検索キーワード |
| manual_id | string | - | 参照マニュアルID |
| response_time | number | - | レスポンス時間(ms) |

#### 4.2.4 問い合わせデータ (inquiries)
| フィールド名 | データ型 | 必須 | 説明 |
|-------------|----------|------|------|
| id | string | ○ | 問い合わせID（主キー） |
| timestamp | datetime | ○ | 受付日時 |
| line_id | string | ○ | LINE ユーザーID |
| user_name | string | ○ | ユーザー名 |
| type | string | ○ | 問い合わせ種別 |
| content | text | ○ | 問い合わせ内容 |
| status | string | ○ | 対応ステータス |
| assignee | string | - | 対応者 |
| response | text | - | 対応内容 |
| resolved_at | datetime | - | 対応完了日時 |

#### 4.2.5 システム設定 (settings)
| フィールド名 | データ型 | 必須 | 説明 |
|-------------|----------|------|------|
| key | string | ○ | 設定キー（主キー） |
| value | string | ○ | 設定値 |
| description | string | - | 設定の説明 |

### 4.3 APIエンドポイント
- **メインWebhook**: `/api/webhook` - LINE イベント処理
- **ヘルスチェック**: `/api/health` - システム稼働確認
- **管理機能**: 内部処理（公開API無し）

### 4.4 環境変数
```env
# LINE設定（必須）
LINE_CHANNEL_ACCESS_TOKEN=your_channel_access_token
LINE_CHANNEL_SECRET=your_channel_secret

# Google設定（必須）
GOOGLE_SERVICE_ACCOUNT_EMAIL=service_account@project.iam.gserviceaccount.com
GOOGLE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
SPREADSHEET_ID=your_spreadsheet_id

# 管理者設定（必須）
ADMIN_LINE_IDS=admin_id_1,admin_id_2

# オプション設定
ALLOWED_EMAIL_DOMAINS=company.com,example.org  # 許可メールドメイン
RICH_MENU_MAIN_ID=richmenu_main_id             # 一般用リッチメニューID
RICH_MENU_ADMIN_ID=richmenu_admin_id           # 管理者用リッチメニューID

# システム設定
MAINTENANCE_MODE=false                          # メンテナンスモード切り替え
SEARCH_CACHE_MINUTES=5                         # 検索結果キャッシュ時間（分）
SESSION_TIMEOUT_MINUTES=10                     # セッションタイムアウト時間（分）
```

---

## 5. ユーザーストーリー

### 5.1 一般従業員のユースケース
1. **初回利用**: LINE Bot友だち追加 → 登録フロー → メール・氏名入力 → 利用開始
2. **マニュアル検索**: 「経費精算」と入力 → 関連マニュアル一覧表示 → 詳細閲覧
3. **カテゴリ検索**: リッチメニュー「経理」選択 → カテゴリ内マニュアル一覧 → 選択閲覧
4. **問い合わせ**: 「問い合わせ」選択 → 種別選択 → 内容入力 → 送信完了

### 5.2 管理者のユースケース
1. **統計確認**: 「admin」コマンド → システム統計表示
2. **ユーザー管理**: 「admin users」 → 登録ユーザー一覧表示
3. **問い合わせ対応**: 「admin inquiries」 → 未対応問い合わせ一覧確認
4. **システム監視**: 「admin system」 → システム状態・ログ確認

---

## 6. 制約事項・前提条件

### 6.1 技術的制約
- **プラットフォーム制約**: Vercel Serverless Functions（実行時間制限、メモリ制限）
- **データベース制約**: Google Sheets（行数制限、API制限）
- **LINE API制約**: 月間メッセージ配信数制限

### 6.2 運用制約
- **メンテナンス**: Google Sheets上でのマニュアル更新は手動運用
- **権限変更**: ユーザー権限変更はスプレッドシート上で手動変更
- **リッチメニュー**: 画像作成・更新は手動作業

### 6.3 セキュリティ制約
- **認証方式**: LINE認証のみ（追加認証なし）
- **データ保存**: Google Sheets上での平文保存
- **アクセス制御**: アプリケーションレベルでの制御のみ

---

## 7. 開発・運用計画

### 7.1 開発フェーズ（チケットベース）

#### Phase 1: 基盤・環境構築
- **Ticket #001-003**: プロジェクト設定、API認証、データベース設計
- **期間**: 1週間
- **完了条件**: Vercelデプロイ成功、Google Sheets連携確認

#### Phase 2: 認証・ユーザー管理
- **Ticket #004-005**: LINE認証基盤、ユーザー登録機能
- **期間**: 1週間  
- **完了条件**: ユーザー登録フロー動作確認

#### Phase 3: UI/UX・基本機能
- **Ticket #007-009**: リッチメニュー、メッセージハンドラー、検索機能
- **期間**: 1-2週間
- **完了条件**: 基本的なBOT機能動作確認

#### Phase 4: 管理・問い合わせ機能
- **Ticket #013**: 問い合わせシステム、管理者コマンド
- **期間**: 1週間
- **完了条件**: 管理機能一式動作確認

#### Phase 5: テスト・リリース
- **Ticket #016-018**: テスト計画、デプロイ、運用マニュアル
- **期間**: 1週間
- **完了条件**: 本番リリース準備完了

### 7.2 運用・監視計画

#### KPI管理
- **MAU** (Monthly Active Users): 月間利用者数
- **検索成功率**: 検索結果への満足度
- **平均レスポンス時間**: システム応答時間
- **問い合わせ対応時間**: 平均対応完了時間
- **ユーザー満足度**: アンケートベースの満足度

#### 監視体制
- **日次監視**: エラーログ、未対応問い合わせ
- **週次監視**: 利用統計、検索キーワード分析  
- **月次監視**: ログアーカイブ、利用レポート

### 7.3 今後の拡張予定

#### 機能拡張
- **承認フロー**: マニュアル更新の承認ワークフロー
- **多言語対応**: 英語・中国語等の多言語サポート
- **検索精度向上**: AI・機械学習による検索精度向上
- **モバイルアプリ**: LINEミニアプリ化

#### 技術的改善
- **状態管理**: Redis等による永続的セッション管理
- **キャッシュ機能**: 検索結果・マニュアルデータのキャッシュ
- **監視強化**: APM導入によるパフォーマンス監視
- **データベース移行**: PostgreSQL等への移行検討

---

**文書管理**
- 作成者: Claude Code
- 承認者: （要承認）
- 次回レビュー予定: 2025年9月27日